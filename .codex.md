# Codex 配置文件

## 🌏 语言要求（最高优先级）

**强制规则：永远使用简体中文作答**

- ✅ **所有输出必须使用简体中文**（包括代码注释、文档、说明）
- ✅ **思考过程可以用英文进行，但显示给用户的内容必须翻译成中文**
- ✅ **代码注释必须使用简体中文**
- ✅ **文档和说明必须使用简体中文**
- ✅ **错误信息和警告必须使用简体中文**
- ❌ 禁止使用英文与用户交流（除非用户明确要求）

**示例**：
```
✅ 正确：
思考：我需要分析批次大小对性能的影响...
输出：批次大小从 5 增加到 50，可以提升约 10 倍性能。

❌ 错误：
Thinking: I need to analyze the batch size impact...
Output: Increasing batch size from 5 to 50 can improve performance by ~10x.
```

### 💬 回答风格（高优先级）

> **核心：默认极简，按需展开。**

- ✅ **默认强制简洁**：每次回答优先控制在「3–6 行」或「不超过 3 个要点」，能一句话说清就不用第二句
- ✅ 只有在用户**明确表示**：
  - “详细一点”“展开讲讲”“帮我系统梳理一下”
  - 或者说“我没太懂这块，你展开说说”
  时，才输出长篇解释 / 系统方案
- ✅ 对于明显复杂的问题（架构设计、完整 SEO 方案等），先给**极简版结论 + 选项**，再问用户是否需要详细版
- ✅ 代码改动类问题优先用**简短列表**概括“改了什么”和“为什么”，避免堆长段文字
- ❌ 用户没要时，不要主动写教程、背景知识长文，不要自动给 roadmap / 全量 checklist

---

## 📋 项目背景

- **项目名称**：Gempix2
- **技术栈**：Next.js 15, TypeScript, next-intl, TailwindCSS
- **AI 模型**：Gempix2 (Nano Banana 2) (图像生成)
- **多语言支持**：11 种语言（en, zh, ja, ko, es, fr, de, it, pt, ru, ar）

---

## 📚 文档管理规则

### 目录结构

项目文档统一存放在 `docs/` 目录，按功能分类：

```
docs/
├── README.md                    # 文档中心说明
├── setup/                       # 配置和设置指南
│   ├── CONFIGURATION_CHECKLIST.md
│   ├── EMAIL_AUTH_SETUP.md
│   └── STRIPE_WEBHOOK_SETUP.md
├── testing/                     # 测试指南
│   ├── VEO3_TESTING_GUIDE.md
│   ├── EMAIL_TEST_GUIDE.md
│   └── VERIFICATION_CODE_TEST_GUIDE.md
├── marketing/                   # 营销和合规文档
│   ├── gempix2-introduction-ko.md
│   ├── creem-compliance-email.md
│   └── creem-compliance-evidence.md
└── archived/                    # 已完成/过时文档
    ├── DOMAIN_MIGRATION_GUIDE.md
    ├── SEO_FINAL_CHECK_REPORT.md
    └── ...
```

### 文档分类原则

#### **setup/** - 配置和设置指南
- 用途：项目部署、功能配置、环境设置
- 维护：持续更新，随配置变化而更新
- 示例：配置清单、认证设置、支付配置

#### **testing/** - 测试指南
- 用途：各功能模块的测试方法和最佳实践
- 维护：持续维护，保持测试指南的准确性
- 示例：功能测试指南、Mock 测试方法

#### **marketing/** - 营销和合规
- 用途：市场推广内容、合规文档、对外材料
- 维护：根据营销需求和合规要求更新
- 示例：产品介绍、合规证明、邮件模板

#### **archived/** - 已完成/过时文档
- 用途：保留历史记录和已完成的一次性任务
- 维护：只增不改，作为历史记录保存

### 文档命名规范

- 使用大写字母和下划线：`FEATURE_NAME_GUIDE.md`
- 明确文档类型后缀：
  - `_GUIDE.md` - 操作指南
  - `_SETUP.md` - 配置说明
  - `_CHECKLIST.md` - 检查清单
  - `_REPORT.md` - 报告文档
  - `_FAQ.md` - 常见问题

### Git 版本控制

- **docs/ 目录不提交到 git**（已添加到 .gitignore）
- 原因：
  - 文档是本地工作记录
  - 避免频繁的文档更新污染 git 历史
  - 每个开发者可以维护自己的文档版本
- 例外：README.md 等核心文档可以提交

---

## 🛠️ 项目特定规则

### 数据库工具

**scripts/verify-tables.ts**
- 功能：数据库表验证和诊断工具（只读）
- 用途：检查表结构、统计记录数
- 使用：`tsx scripts/verify-tables.ts`

### 域名配置

- 当前域名：`gempix2.site`
- 旧域名迁移已完成（gempix2.org → gempix2.site）
- 相关文档：`docs/archived/DOMAIN_MIGRATION_GUIDE.md`

### SEO 优化

- Canonical 标签已配置
- Schema.org 结构化数据已添加
- 相关文档：`docs/archived/SEO_FINAL_CHECK_REPORT.md`

### 多语言翻译规则

**重要：翻译任务由用户手动执行**

当需要进行多语言翻译时，Claude Code / Codex 应该：
1. ✅ 准备好基准文件（如中文源文件）
2. ✅ 创建或更新翻译脚本
3. ✅ 提供脚本执行命令
4. ❌ **不要**自动运行翻译脚本

**原因**：
- 翻译消耗 API 配额和费用
- 用户需要控制翻译时机
- 避免意外的大量 API 调用

**示例工作流**：
```bash
# Claude 只提供命令，不执行
# API Key 已配置到系统环境变量（~/.zshrc），直接运行即可
./scripts/deepseek-translator/translate-batch.sh zh cases/zh.json \
  --dir ./src/i18n/pages/prompts \
  --batch-size 20
```

**已有翻译工具**：
- `scripts/deepseek-translator/translator.ts` - 单语言翻译
- `scripts/deepseek-translator/translate-batch.sh` - 批量多语言翻译

### 提示词多语言支持

**实现方式**：
- 提示词标题存储在 `src/i18n/pages/prompts/cases/{lang}.json`
- 中文为基准语言（`zh.json`）
- 通过 `src/lib/prompt-titles.ts` 工具函数加载翻译
- 组件使用 `useTranslations('caseTitles')` 获取翻译

**翻译流程**：
1. 从 CDN 提取中文标题 → `cases/zh.json`
2. 用户手动运行翻译脚本生成其他语言
3. 页面加载时根据 locale 自动选择对应翻译

---

## 🛠️ 翻译工作流详解

### 工具路径

- 翻译脚本：`scripts/deepseek-translator/translator.ts`
- 批量翻译：`scripts/deepseek-translator/translate-batch.sh`

### API 配置

- API Key：环境变量 `DEEPSEEK_API_KEY`（已配置在 `~/.zshrc`）
- API 特点：**无固定速率限制**，支持高并发

### 性能优化参数

```typescript
batchSize: 50       // DeepSeek API 无固定限流，可高并发
批次延迟: 10ms      // 减少等待时间
force: false        // 默认跳过已翻译内容
```

### 翻译命令模板

```bash
# 基础翻译（跳过已翻译）
npx tsx scripts/deepseek-translator/translator.ts <source-lang> <target-lang> <file-path>

# 强制覆盖
npx tsx scripts/deepseek-translator/translator.ts <source-lang> <target-lang> <file-path> --force

# 指定批次大小
npx tsx scripts/deepseek-translator/translator.ts <source-lang> <target-lang> <file-path> --batch-size 50

# 批量翻译到多语言
./scripts/deepseek-translator/translate-batch.sh <source-lang> <file-path>
```

### i18n 文件结构

```
src/i18n/pages/
├── landing/          # 首页翻译
│   ├── en.json
│   ├── zh.json
│   └── ...
├── prompts/          # Prompts 页面
│   ├── en.json       # 页面 UI 翻译
│   ├── zh.json
│   └── cases/        # 案例标题翻译（独立）
│       ├── en.json
│       ├── zh.json
│       └── ...
```

**关键实现**：
- 标题翻译：`src/lib/prompt-titles.ts`（加载和缓存）
- 服务端加载：`page.tsx` 中通过 `loadPromptTitles()` 加载
- 客户端使用：`useTranslations('caseTitles')` 访问

### Prompts 多语言实现

**数据源分离**：
- Prompts 数据：GitHub CDN (Statically)
- 标题翻译：本地 `src/i18n/pages/prompts/cases/`

**实现流程**：
1. 更新 GitHub CDN 数据源
2. 提取中文标题到 `cases/zh.json`
3. 运行翻译命令生成其他语言
4. 组件自动加载对应语言的翻译

---

## 🎯 性能优化原则

### 批处理优化策略

**三层速率控制**：
1. **批次大小**（batchSize）：控制每批并发请求数
2. **批次内并发**（Promise.all）：批次内所有请求同时发出
3. **批次间延迟**（delay）：给 API 服务器缓冲时间

**最佳实践**：
- 先调研 API 限流政策，不要盲目保守
- 批次大小根据 API 能力调整（如 DeepSeek 可用 50）
- 提供性能对比数据，证明优化效果

**时间计算公式**：
```
总时间 = 批次数 × (单批耗时 + 批次延迟)
批次数 = 总任务数 ÷ batchSize

示例（420 个任务）：
- batchSize = 5:  84批 × 3秒 ≈ 252秒 (4.2分钟)
- batchSize = 50: 9批 × 3秒 ≈ 27秒
- 提速约 9 倍
```

---

## ⚠️ 注意事项

### 翻译相关
- ⚠️ 翻译会产生 API 费用，谨慎使用 `--force`
- ⚠️ 已翻译文件不要手动修改，使用 `--force` 重新生成
- ⚠️ 环境变量已配置在 `~/.zshrc`，不需要每次 export

---

## 📚 历史决策记录

### 2025-11-14: 翻译脚本性能优化
- **问题**：批处理速度太慢（batchSize: 5，84批，约4分钟）
- **调研**：DeepSeek API 无固定速率限制，支持高并发
- **解决方案**：
  - 提升 batchSize 至 50
  - 减少批次延迟至 10ms
  - 添加 --force 参数和跳过已翻译逻辑
- **效果**：速度提升约 8-10 倍（从4分钟降至约30秒）
- **教训**：不要盲目保守，先调研 API 能力再优化

### 2025-11-14: Prompts 多语言支持
- **需求**：420 个 Prompt 标题支持多语言
- **方案**：
  - 数据源（GitHub CDN）与翻译（本地）分离
  - 使用 next-intl 嵌套命名空间（`caseTitles`）
  - 服务端预加载翻译，客户端无感切换
- **实现**：
  - `src/lib/prompt-titles.ts`：加载和缓存翻译
  - `page.tsx`：服务端加载，传递给客户端
  - `PromptCard/PromptModal`：使用 `useTranslations('caseTitles')`

---

## 🎯 最佳实践总结

1. **永远使用简体中文作答**（最高优先级）
2. **先调研文档，后优化代码**（避免盲目保守）
3. **批处理优先考虑并发性能**（Promise.all + 合理 batchSize）
4. **提供性能对比数据**（证明优化效果）
5. **翻译任务由用户手动执行**（不自动运行翻译脚本）

---

*最后更新：2025-11-14*
*配置版本：v2.0*
